import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const projectRoot = path.resolve(__dirname, '..');
const packageJsonPath = path.join(projectRoot, 'package.json');
const publicDir = path.join(projectRoot, 'public');
const srcLibDir = path.join(projectRoot, 'src', 'lib');

const pkg = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
const version = String(pkg.version || '0.0.0');
const buildTime = new Date().toISOString();
const buildId = `${version}-${Date.now()}`;

fs.mkdirSync(publicDir, { recursive: true });
fs.mkdirSync(srcLibDir, { recursive: true });

const versionJsonPath = path.join(publicDir, 'version.json');
fs.writeFileSync(
  versionJsonPath,
  JSON.stringify({ version, buildId, buildTime }, null, 2) + '\n',
  'utf8'
);

const buildInfoJsPath = path.join(srcLibDir, 'buildInfo.js');
fs.writeFileSync(
  buildInfoJsPath,
  [
    '// This file is auto-generated by scripts/generate-build-info.mjs',
    `export const APP_VERSION = ${JSON.stringify(version)};`,
    `export const BUILD_ID = ${JSON.stringify(buildId)};`,
    `export const BUILD_TIME = ${JSON.stringify(buildTime)};`,
    'export const BUILD_INFO = { version: APP_VERSION, buildId: BUILD_ID, buildTime: BUILD_TIME };',
    ''
  ].join('\n'),
  'utf8'
);

console.log(`[build-info] version=${version} buildId=${buildId} buildTime=${buildTime}`);

